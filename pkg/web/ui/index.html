<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkillServer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/style.css">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body>
    <div x-data="skillServer()" x-init="loadSkills(); initKeyboardShortcuts()" @keydown.window="handleKeyboardShortcut($event)" class="container">
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div class="flex items-center gap-3 cursor-pointer hover:opacity-80 transition-opacity" @click="cancelEdit()">
                <img src="/images/logo.png" alt="SkillServer Logo" class="h-8 sm:h-10 w-auto">
                <h1 class="text-2xl sm:text-3xl">SkillServer</h1>
            </div>
            <div class="header-actions w-full sm:w-auto">
                <button @click="showEditor = true; editingSkill = null; skillContent = ''; skillName = ''; skillDescription = ''; skillLicense = ''; skillCompatibility = ''; nameValidationError = ''" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i>New Skill
                </button>
            </div>
        </header>

        <!-- Search Bar -->
        <div class="search-bar relative">
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            <input 
                type="text" 
                x-model="searchQuery" 
                @input="searchSkills()"
                placeholder="Search skills..."
                class="search-input pl-10 pr-20"
                id="search-input"
            >
            <button 
                x-show="searchQuery"
                @click="searchQuery = ''; searchSkills()"
                class="absolute right-10 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
            >
                <i class="fas fa-times"></i>
            </button>
            <div x-show="searchQuery && filteredSkills.length > 0" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-sm text-gray-500">
                <span x-text="filteredSkills.length"></span> result<span x-show="filteredSkills.length !== 1">s</span>
            </div>
        </div>

        <!-- Skills List -->
        <div class="skills-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5" x-show="!showEditor">
            <template x-for="skill in filteredSkills" :key="skill.name">
                <div class="skill-card" @click="editSkill(skill)">
                    <div class="skill-card-header">
                        <h3 x-text="skill.name"></h3>
                        <span x-show="skill.readOnly" class="read-only-badge">
                            <i class="fas fa-lock mr-1"></i>Read-only
                        </span>
                    </div>
                    <p x-text="skill.description || 'No description'" class="skill-description"></p>
                    <div class="skill-actions">
                        <button x-show="!skill.readOnly" @click.stop="deleteSkill(skill.name)" class="btn btn-small btn-danger">
                            <i class="fas fa-trash mr-1"></i>Delete
                        </button>
                    </div>
                </div>
            </template>
            <div x-show="filteredSkills.length === 0" class="empty-state">
                <i class="fas fa-inbox text-6xl mb-4 text-gray-300"></i>
                <p class="text-xl mb-2">No skills found</p>
                <p class="text-gray-500 mb-4">Create your first skill to get started!</p>
                <button @click="showEditor = true; editingSkill = null; skillContent = ''; skillName = ''; skillDescription = ''; skillLicense = ''; skillCompatibility = ''; nameValidationError = ''" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i>Create Skill
                </button>
            </div>
        </div>

        <!-- Editor -->
        <div class="editor" x-show="showEditor">
            <div class="editor-header flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <h2 class="text-xl sm:text-2xl" x-text="editingSkill ? 'Edit Skill' : 'New Skill'"></h2>
                <div x-show="!editingSkill || !editingSkill.readOnly" class="editor-actions flex gap-2 w-full sm:w-auto">
                    <button @click="saveSkill()" class="btn btn-primary" :disabled="isLoading">
                        <i x-show="!isLoading" class="fas fa-save mr-2"></i>
                        <i x-show="isLoading" class="fas fa-spinner fa-spin mr-2"></i>Save
                    </button>
                    <button @click="cancelEdit()" class="btn btn-secondary">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                </div>
            </div>
            <div x-show="editingSkill && editingSkill.readOnly" class="read-only-warning">
                <i class="fas fa-lock mr-2"></i><strong>Read-only:</strong> This skill is from a git repository and cannot be edited.
            </div>
            
            <!-- Tabs -->
            <div class="tabs flex gap-2 overflow-x-auto" x-show="editingSkill !== null">
                <button @click="activeTab = 'content'" :class="{'tab': true, 'active': activeTab === 'content'}">
                    <i class="fas fa-file-alt mr-2"></i>Content
                </button>
                <button @click="activeTab = 'resources'; loadResources()" :class="{'tab': true, 'active': activeTab === 'resources'}" :disabled="!editingSkill">
                    <i class="fas fa-folder mr-2"></i>Resources
                </button>
            </div>
            
            <!-- Content Tab -->
            <div x-show="activeTab === 'content' || editingSkill === null">
                <div class="form-group">
                    <label class="form-label">Skill Name (must match directory name)</label>
                    <div class="relative">
                        <input 
                            type="text" 
                            x-model="skillName" 
                            @input="validateName()"
                            placeholder="skill-name (lowercase, numbers, hyphens only)"
                            :disabled="editingSkill !== null || (editingSkill && editingSkill.readOnly)"
                            :class="{
                                'border-red-500': nameValidationError,
                                'border-green-500': !nameValidationError && skillName && skillName.trim().length > 0
                            }"
                            class="skill-name-input full-width pr-10"
                        >
                        <i 
                            x-show="nameValidationError"
                            class="fas fa-exclamation-circle text-red-500 absolute right-3 top-1/2 transform -translate-y-1/2"
                        ></i>
                        <i 
                            x-show="!nameValidationError && skillName && skillName.trim().length > 0"
                            class="fas fa-check-circle text-green-500 absolute right-3 top-1/2 transform -translate-y-1/2"
                        ></i>
                    </div>
                    <p x-show="nameValidationError" class="error-message flex items-center gap-1 mt-1" x-text="nameValidationError">
                        <i class="fas fa-exclamation-circle"></i>
                    </p>
                </div>
                <div class="form-group">
                    <label class="form-label">Description <span class="required-indicator">*</span></label>
                    <textarea 
                        x-model="skillDescription" 
                        placeholder="A description of what this skill does and when to use it (1-1024 characters)"
                        :disabled="editingSkill && editingSkill.readOnly"
                        :class="{
                            'border-red-500': skillDescription.length > 1024 || (skillDescription.length === 0 && skillDescription.trim().length === 0),
                            'border-green-500': skillDescription.length > 0 && skillDescription.length <= 1024
                        }"
                        class="form-textarea"
                    ></textarea>
                    <div class="flex justify-between items-center mt-1">
                        <span class="text-xs text-gray-500 flex items-center gap-1">
                            <i class="fas fa-info-circle"></i>
                            Required: 1-1024 characters
                        </span>
                        <span 
                            :class="{
                                'text-red-600': skillDescription.length > 1024,
                                'text-yellow-600': skillDescription.length > 900 && skillDescription.length <= 1024,
                                'text-gray-500': skillDescription.length <= 900
                            }"
                            class="text-xs font-medium flex items-center gap-1"
                        >
                            <i x-show="skillDescription.length > 1024" class="fas fa-exclamation-triangle"></i>
                            <span x-text="skillDescription.length"></span>/1024
                        </span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">License (optional)</label>
                    <input 
                        type="text" 
                        x-model="skillLicense" 
                        placeholder="e.g., Apache-2.0"
                        :disabled="editingSkill && editingSkill.readOnly"
                        class="skill-name-input full-width"
                    >
                </div>
                <div class="form-group">
                    <label class="form-label">Compatibility (optional, max 500 chars)</label>
                    <input 
                        type="text" 
                        x-model="skillCompatibility" 
                        placeholder="e.g., Requires git, docker, jq"
                        :disabled="editingSkill && editingSkill.readOnly"
                        class="skill-name-input full-width"
                    >
                    <div class="flex justify-end items-center mt-1">
                        <span 
                            :class="{
                                'text-red-600': skillCompatibility.length > 500,
                                'text-yellow-600': skillCompatibility.length > 450 && skillCompatibility.length <= 500,
                                'text-gray-500': skillCompatibility.length <= 450
                            }"
                            class="text-xs font-medium"
                        >
                            <span x-text="skillCompatibility.length"></span>/500
                        </span>
                    </div>
                </div>
                <div class="form-group">
                    <div class="flex justify-between items-center mb-2">
                        <label class="form-label mb-0">Content (Markdown)</label>
                        <button 
                            type="button"
                            @click="markdownPreview = !markdownPreview"
                            class="text-sm px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded transition"
                            :disabled="editingSkill && editingSkill.readOnly"
                        >
                            <i :class="markdownPreview ? 'fa-edit' : 'fa-eye'" class="fas mr-1"></i>
                            <span x-text="markdownPreview ? 'Edit' : 'Preview'"></span>
                        </button>
                    </div>
                    <div x-show="!markdownPreview">
                        <textarea 
                            x-model="skillContent" 
                            placeholder="Enter markdown content here..."
                            :disabled="editingSkill && editingSkill.readOnly"
                            class="editor-textarea"
                        ></textarea>
                    </div>
                    <div x-show="markdownPreview" class="editor-textarea bg-gray-50 overflow-auto" x-html="renderMarkdown(skillContent)"></div>
                </div>
            </div>
            
            <!-- Resources Tab -->
            <div x-show="activeTab === 'resources' && editingSkill !== null">
                <div class="resource-section">
                    <div class="resource-section-header flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                        <h3><i class="fas fa-code mr-2"></i>Scripts</h3>
                        <button @click="showUploadDialog('script')" class="btn btn-small btn-primary w-full sm:w-auto" :disabled="editingSkill && editingSkill.readOnly">
                            <i class="fas fa-upload mr-1"></i>Upload
                        </button>
                    </div>
                    <div 
                        class="resource-list"
                        @dragover.prevent="dragOverType = 'script'"
                        @dragleave.prevent="if (event.relatedTarget === null || !event.currentTarget.contains(event.relatedTarget)) dragOverType = null"
                        @drop.prevent="handleDrop($event, 'script')"
                        :class="{'border-2 border-blue-500 border-dashed bg-blue-50': dragOverType === 'script'}"
                    >
                        <template x-for="resource in resources.scripts" :key="resource.path">
                            <div class="resource-item flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                                <div class="resource-item-info flex-1 min-w-0" @click="viewResource(resource, 'script')">
                                    <div class="resource-item-name" x-text="resource.name"></div>
                                    <div class="resource-item-meta" x-text="`${formatSize(resource.size)} • ${resource.mime_type}`"></div>
                                </div>
                                <div class="resource-item-actions flex gap-2">
                                    <button @click.stop="deleteResource(resource.path)" class="btn btn-small btn-danger" :disabled="editingSkill && editingSkill.readOnly">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </template>
                        <div x-show="!resources.scripts || resources.scripts.length === 0" class="empty-resource-state">
                            <i class="fas fa-code text-4xl mb-2 text-gray-300"></i>
                            <p>No scripts</p>
                        </div>
                    </div>
                </div>
                
                <div class="resource-section">
                    <div class="resource-section-header flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                        <h3><i class="fas fa-book mr-2"></i>References</h3>
                        <button @click="showUploadDialog('reference')" class="btn btn-small btn-primary w-full sm:w-auto" :disabled="editingSkill && editingSkill.readOnly">
                            <i class="fas fa-upload mr-1"></i>Upload
                        </button>
                    </div>
                    <div 
                        class="resource-list"
                        @dragover.prevent="dragOverType = 'reference'"
                        @dragleave.prevent="if (event.relatedTarget === null || !event.currentTarget.contains(event.relatedTarget)) dragOverType = null"
                        @drop.prevent="handleDrop($event, 'reference')"
                        :class="{'border-2 border-blue-500 border-dashed bg-blue-50': dragOverType === 'reference'}"
                    >
                        <template x-for="resource in resources.references" :key="resource.path">
                            <div class="resource-item flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                                <div class="resource-item-info flex-1 min-w-0" @click="viewResource(resource, 'reference')">
                                    <div class="resource-item-name" x-text="resource.name"></div>
                                    <div class="resource-item-meta" x-text="`${formatSize(resource.size)} • ${resource.mime_type}`"></div>
                                </div>
                                <div class="resource-item-actions flex gap-2">
                                    <button @click.stop="deleteResource(resource.path)" class="btn btn-small btn-danger" :disabled="editingSkill && editingSkill.readOnly">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </template>
                        <div x-show="!resources.references || resources.references.length === 0" class="empty-resource-state">
                            <i class="fas fa-book text-4xl mb-2 text-gray-300"></i>
                            <p>No references</p>
                        </div>
                    </div>
                </div>
                
                <div class="resource-section">
                    <div class="resource-section-header flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                        <h3><i class="fas fa-image mr-2"></i>Assets</h3>
                        <button @click="showUploadDialog('asset')" class="btn btn-small btn-primary w-full sm:w-auto" :disabled="editingSkill && editingSkill.readOnly">
                            <i class="fas fa-upload mr-1"></i>Upload
                        </button>
                    </div>
                    <div 
                        class="resource-list"
                        @dragover.prevent="dragOverType = 'asset'"
                        @dragleave.prevent="if (event.relatedTarget === null || !event.currentTarget.contains(event.relatedTarget)) dragOverType = null"
                        @drop.prevent="handleDrop($event, 'asset')"
                        :class="{'border-2 border-blue-500 border-dashed bg-blue-50': dragOverType === 'asset'}"
                    >
                        <template x-for="resource in resources.assets" :key="resource.path">
                            <div class="resource-item flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                                <div class="resource-item-info flex-1 min-w-0" @click="viewResource(resource, 'asset')">
                                    <div class="resource-item-name" x-text="resource.name"></div>
                                    <div class="resource-item-meta" x-text="`${formatSize(resource.size)} • ${resource.mime_type}`"></div>
                                </div>
                                <div class="resource-item-actions flex gap-2">
                                    <button @click.stop="deleteResource(resource.path)" class="btn btn-small btn-danger" :disabled="editingSkill && editingSkill.readOnly">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </template>
                        <div x-show="!resources.assets || resources.assets.length === 0" class="empty-resource-state">
                            <i class="fas fa-image text-4xl mb-2 text-gray-300"></i>
                            <p>No assets</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div 
            x-show="confirmModal.show"
            @keydown.escape.window="confirmModal.show = false; if (confirmModal.callback) { confirmModal.callback(false); confirmModal.callback = null; }"
            class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
            style="display: none;"
        >
            <div 
                @click.stop
                class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4"
            >
                <h3 class="text-lg font-semibold mb-4 text-gray-900">Confirm</h3>
                <p class="text-gray-700 mb-6" x-text="confirmModal.message"></p>
                <div class="flex gap-3 justify-end">
                    <button 
                        @click="confirmModal.show = false; if (confirmModal.callback) { confirmModal.callback(false); confirmModal.callback = null; }"
                        class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition"
                    >
                        Cancel
                    </button>
                    <button 
                        @click="confirmModal.show = false; if (confirmModal.callback) { confirmModal.callback(true); confirmModal.callback = null; }"
                        class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition"
                    >
                        Confirm
                    </button>
                </div>
            </div>
        </div>

        <!-- Resource Editor Modal -->
        <div 
            x-show="resourceEditorModal.show"
            @keydown.escape.window="resourceEditorModal.show = false"
            class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
            style="display: none;"
        >
            <div 
                @click.stop
                class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col"
            >
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-lg font-semibold">
                        <i class="fas fa-edit mr-2"></i>Edit <span x-text="resourceEditorModal.name"></span>
                    </h3>
                    <button 
                        @click="resourceEditorModal.show = false"
                        class="text-gray-400 hover:text-gray-600"
                    >
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="flex-1 overflow-auto p-4">
                    <textarea 
                        x-model="resourceEditorModal.content"
                        class="w-full h-full min-h-[400px] p-3 border border-gray-300 rounded font-mono text-sm"
                        style="font-family: 'Monaco', 'Courier New', monospace;"
                    ></textarea>
                </div>
                <div class="flex justify-end gap-3 p-4 border-t">
                    <button 
                        @click="resourceEditorModal.show = false"
                        class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition"
                    >
                        Cancel
                    </button>
                    <button 
                        @click="saveResourceContent()"
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition"
                    >
                        <i class="fas fa-save mr-2"></i>Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div x-data="skillServer()" class="fixed top-4 right-4 z-50 space-y-2" style="max-width: 400px;">
        <template x-for="(toast, index) in toasts" :key="index">
            <div 
                x-show="toast.show"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 transform translate-x-full"
                x-transition:enter-end="opacity-100 transform translate-x-0"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 transform translate-x-0"
                x-transition:leave-end="opacity-0 transform translate-x-full"
                :class="{
                    'bg-green-500': toast.type === 'success',
                    'bg-red-500': toast.type === 'error',
                    'bg-yellow-500': toast.type === 'warning',
                    'bg-blue-500': toast.type === 'info'
                }"
                class="text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-3"
            >
                <i :class="{
                    'fa-check-circle': toast.type === 'success',
                    'fa-exclamation-circle': toast.type === 'error',
                    'fa-exclamation-triangle': toast.type === 'warning',
                    'fa-info-circle': toast.type === 'info'
                }" class="fas text-lg"></i>
                <span class="flex-1" x-text="toast.message"></span>
                <button @click="toast.show = false; setTimeout(() => toasts.splice(index, 1), 200)" class="text-white hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </template>
    </div>

    <script>
        function skillServer() {
            return {
                skills: [],
                filteredSkills: [],
                searchQuery: '',
                showEditor: false,
                editingSkill: null,
                skillName: '',
                skillDescription: '',
                skillContent: '',
                skillLicense: '',
                skillCompatibility: '',
                nameValidationError: '',
                activeTab: 'content',
                resources: {
                    scripts: [],
                    references: [],
                    assets: []
                },
                viewingResource: null,
                uploadType: null,
                markdownPreview: false,
                dragOverType: null,
                resourceEditorModal: {
                    show: false,
                    content: '',
                    originalContent: '',
                    path: '',
                    name: ''
                },
                toasts: [],
                isLoading: false,
                confirmModal: {
                    show: false,
                    message: '',
                    callback: null
                },

                showToast(message, type = 'info') {
                    const toast = {
                        message,
                        type,
                        show: true
                    };
                    this.toasts.push(toast);
                    setTimeout(() => {
                        toast.show = false;
                        setTimeout(() => {
                            const index = this.toasts.indexOf(toast);
                            if (index > -1) this.toasts.splice(index, 1);
                        }, 200);
                    }, 3000);
                },

                showConfirm(message) {
                    return new Promise((resolve) => {
                        this.confirmModal.message = message;
                        this.confirmModal.callback = (result) => {
                            resolve(result);
                            this.confirmModal.callback = null;
                        };
                        this.confirmModal.show = true;
                    });
                },

                initKeyboardShortcuts() {
                    // Keyboard shortcuts are handled in handleKeyboardShortcut
                },

                handleKeyboardShortcut(event) {
                    // Ctrl/Cmd+K to focus search
                    if ((event.ctrlKey || event.metaKey) && event.key === 'k') {
                        event.preventDefault();
                        const searchInput = document.getElementById('search-input');
                        if (searchInput) {
                            searchInput.focus();
                            searchInput.select();
                        }
                        return;
                    }

                    // Only handle shortcuts when editor is visible
                    if (!this.showEditor) return;

                    // Ctrl/Cmd+S to save
                    if ((event.ctrlKey || event.metaKey) && event.key === 's') {
                        event.preventDefault();
                        if (!this.isLoading && (!this.editingSkill || !this.editingSkill.readOnly)) {
                            this.saveSkill();
                        }
                        return;
                    }

                    // Esc to cancel
                    if (event.key === 'Escape') {
                        if (this.resourceEditorModal.show) {
                            this.resourceEditorModal.show = false;
                        } else if (this.confirmModal.show) {
                            this.confirmModal.show = false;
                            if (this.confirmModal.callback) {
                                this.confirmModal.callback(false);
                                this.confirmModal.callback = null;
                            }
                        } else {
                            this.cancelEdit();
                        }
                        return;
                    }
                },

                renderMarkdown(text) {
                    if (!text) return '<p class="text-gray-400 italic">No content to preview</p>';
                    // Simple markdown rendering
                    let html = text
                        .replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold mb-2 mt-4">$1</h1>')
                        .replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold mb-2 mt-3">$1</h2>')
                        .replace(/^### (.*$)/gim, '<h3 class="text-lg font-bold mb-2 mt-2">$1</h3>')
                        .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/gim, '<em>$1</em>')
                        .replace(/`(.*?)`/gim, '<code class="bg-gray-200 px-1 rounded">$1</code>')
                        .replace(/```([\s\S]*?)```/gim, '<pre class="bg-gray-100 p-3 rounded my-2 overflow-x-auto"><code>$1</code></pre>')
                        .replace(/\n/gim, '<br>');
                    return html;
                },

                async loadSkills() {
                    this.isLoading = true;
                    try {
                        const response = await fetch('/api/skills');
                        this.skills = await response.json();
                        this.filteredSkills = this.skills;
                    } catch (error) {
                        console.error('Failed to load skills:', error);
                        this.showToast('Failed to load skills', 'error');
                    } finally {
                        this.isLoading = false;
                    }
                },

                async searchSkills() {
                    if (!this.searchQuery.trim()) {
                        this.filteredSkills = this.skills;
                        return;
                    }

                    this.isLoading = true;
                    try {
                        const response = await fetch(`/api/skills/search?q=${encodeURIComponent(this.searchQuery)}`);
                        this.filteredSkills = await response.json();
                    } catch (error) {
                        console.error('Search failed:', error);
                        this.showToast('Search failed', 'error');
                    } finally {
                        this.isLoading = false;
                    }
                },

                editSkill(skill) {
                    this.editingSkill = skill;
                    this.skillName = skill.name;
                    this.skillDescription = skill.description || '';
                    this.skillContent = skill.content || '';
                    this.skillLicense = skill.license || '';
                    this.skillCompatibility = skill.compatibility || '';
                    this.activeTab = 'content';
                    this.showEditor = true;
                    // Load resources when editing
                    if (skill) {
                        this.loadResources();
                    }
                },

                validateName() {
                    this.nameValidationError = '';
                    const name = this.skillName.trim();
                    if (!name) {
                        this.nameValidationError = 'Skill name is required';
                        return false;
                    }
                    if (name.length > 64) {
                        this.nameValidationError = 'Skill name must be 1-64 characters';
                        return false;
                    }
                    if (name.startsWith('-') || name.endsWith('-')) {
                        this.nameValidationError = 'Skill name cannot start or end with a hyphen';
                        return false;
                    }
                    if (name.includes('--')) {
                        this.nameValidationError = 'Skill name cannot contain consecutive hyphens';
                        return false;
                    }
                    if (!/^[a-z0-9-]+$/.test(name)) {
                        this.nameValidationError = 'Skill name may only contain lowercase letters, numbers, and hyphens';
                        return false;
                    }
                    return true;
                },

                async saveSkill() {
                    if (this.editingSkill && this.editingSkill.readOnly) {
                        this.showToast('Cannot save: This skill is read-only', 'error');
                        return;
                    }

                    if (!this.validateName()) {
                        return;
                    }

                    if (!this.skillDescription.trim()) {
                        this.showToast('Description is required', 'error');
                        return;
                    }
                    if (this.skillDescription.length > 1024) {
                        this.showToast('Description must be 1-1024 characters', 'error');
                        return;
                    }
                    if (this.skillCompatibility && this.skillCompatibility.length > 500) {
                        this.showToast('Compatibility must be max 500 characters', 'error');
                        return;
                    }

                    this.isLoading = true;

                    const url = this.editingSkill 
                        ? `/api/skills/${this.editingSkill.name}`
                        : '/api/skills';
                    
                    const method = this.editingSkill ? 'PUT' : 'POST';
                    const body = JSON.stringify({
                        name: this.skillName,
                        description: this.skillDescription,
                        content: this.skillContent,
                        license: this.skillLicense || undefined,
                        compatibility: this.skillCompatibility || undefined,
                    });

                    try {
                        const response = await fetch(url, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: body,
                        });

                        if (response.ok) {
                            await this.loadSkills();
                            this.showToast('Skill saved successfully', 'success');
                            
                            // Update editingSkill with fresh data from server
                            if (this.editingSkill) {
                                // Reload the skill data to get updated info
                                try {
                                    const skillResponse = await fetch(`/api/skills/${this.skillName}`);
                                    if (skillResponse.ok) {
                                        const updatedSkill = await skillResponse.json();
                                        this.editingSkill = updatedSkill;
                                        // Update form fields with saved data
                                        this.skillName = updatedSkill.name;
                                        this.skillDescription = updatedSkill.description || '';
                                        this.skillContent = updatedSkill.content || '';
                                        this.skillLicense = updatedSkill.license || '';
                                        this.skillCompatibility = updatedSkill.compatibility || '';
                                    }
                                } catch (error) {
                                    console.error('Failed to reload skill:', error);
                                }
                            } else {
                                // For new skills, switch to edit mode with the saved skill
                                try {
                                    const skillResponse = await fetch(`/api/skills/${this.skillName}`);
                                    if (skillResponse.ok) {
                                        const newSkill = await skillResponse.json();
                                        this.editSkill(newSkill);
                                    }
                                } catch (error) {
                                    console.error('Failed to load new skill:', error);
                                }
                            }
                        } else {
                            const error = await response.json();
                            this.showToast('Failed to save: ' + (error.error || 'Unknown error'), 'error');
                        }
                    } catch (error) {
                        console.error('Save failed:', error);
                        this.showToast('Failed to save skill', 'error');
                    } finally {
                        this.isLoading = false;
                    }
                },

                cancelEdit() {
                    this.showEditor = false;
                    this.editingSkill = null;
                    this.skillName = '';
                    this.skillDescription = '';
                    this.skillContent = '';
                    this.skillLicense = '';
                    this.skillCompatibility = '';
                    this.nameValidationError = '';
                    this.activeTab = 'content';
                    this.resources = { scripts: [], references: [], assets: [] };
                    this.viewingResource = null;
                },

                async loadResources() {
                    if (!this.editingSkill) return;
                    
                    try {
                        const response = await fetch(`/api/skills/${this.editingSkill.name}/resources`);
                        if (response.ok) {
                            const data = await response.json();
                            this.resources = {
                                scripts: data.scripts || [],
                                references: data.references || [],
                                assets: data.assets || []
                            };
                        }
                    } catch (error) {
                        console.error('Failed to load resources:', error);
                    }
                },

                async viewResource(resource, type) {
                    if (!resource.readable) {
                        // For binary files, download
                        window.open(`/api/skills/${this.editingSkill.name}/resources/${resource.path}`, '_blank');
                        return;
                    }
                    
                    // For text files, show in editor
                    try {
                        const response = await fetch(`/api/skills/${this.editingSkill.name}/resources/${resource.path}`);
                        if (response.ok) {
                            const content = await response.text();
                            this.viewingResource = {
                                path: resource.path,
                                name: resource.name,
                                type: type,
                                content: content,
                                originalContent: content
                            };
                            // Show resource editor modal
                            this.resourceEditorModal = {
                                show: true,
                                content: content,
                                originalContent: content,
                                path: resource.path,
                                name: resource.name
                            };
                        }
                    } catch (error) {
                        console.error('Failed to load resource:', error);
                        this.showToast('Failed to load resource', 'error');
                    }
                },

                async saveResourceContent() {
                    if (this.resourceEditorModal.content !== this.resourceEditorModal.originalContent) {
                        await this.updateResource(this.resourceEditorModal.path, this.resourceEditorModal.content);
                        this.resourceEditorModal.show = false;
                    } else {
                        this.resourceEditorModal.show = false;
                    }
                },

                async updateResource(path, content) {
                    try {
                        const response = await fetch(`/api/skills/${this.editingSkill.name}/resources/${path}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'text/plain',
                            },
                            body: content,
                        });

                        if (response.ok) {
                            await this.loadResources();
                            this.showToast('Resource updated successfully', 'success');
                        } else {
                            const error = await response.json();
                            this.showToast('Failed to update: ' + (error.error || 'Unknown error'), 'error');
                        }
                    } catch (error) {
                        console.error('Update failed:', error);
                        this.showToast('Failed to update resource', 'error');
                    }
                },

                showUploadDialog(type) {
                    this.uploadType = type;
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            this.uploadResource(file, type);
                        }
                    };
                    input.click();
                },

                handleDrop(event, type) {
                    this.dragOverType = null;
                    const files = event.dataTransfer.files;
                    if (files.length > 0) {
                        this.uploadResource(files[0], type);
                    }
                },

                async uploadResource(file, type) {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('type', type);
                    formData.append('path', `${type}s/${file.name}`);

                    this.isLoading = true;
                    try {
                        const response = await fetch(`/api/skills/${this.editingSkill.name}/resources`, {
                            method: 'POST',
                            body: formData,
                        });

                        if (response.ok) {
                            await this.loadResources();
                            this.showToast('Resource uploaded successfully', 'success');
                        } else {
                            const error = await response.json();
                            this.showToast('Failed to upload: ' + (error.error || 'Unknown error'), 'error');
                        }
                    } catch (error) {
                        console.error('Upload failed:', error);
                        this.showToast('Failed to upload resource', 'error');
                    } finally {
                        this.isLoading = false;
                    }
                },

                async deleteResource(path) {
                    const confirmed = await this.showConfirm(`Are you sure you want to delete "${path}"?`);
                    if (!confirmed) {
                        return;
                    }

                    this.isLoading = true;
                    try {
                        const response = await fetch(`/api/skills/${this.editingSkill.name}/resources/${path}`, {
                            method: 'DELETE',
                        });

                        if (response.ok) {
                            await this.loadResources();
                            this.showToast('Resource deleted successfully', 'success');
                        } else {
                            const error = await response.json();
                            this.showToast('Failed to delete: ' + (error.error || 'Unknown error'), 'error');
                        }
                    } catch (error) {
                        console.error('Delete failed:', error);
                        this.showToast('Failed to delete resource', 'error');
                    } finally {
                        this.isLoading = false;
                    }
                },

                formatSize(bytes) {
                    if (bytes < 1024) return bytes + ' B';
                    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
                },

                async deleteSkill(name) {
                    const confirmed = await this.showConfirm(`Are you sure you want to delete "${name}"?`);
                    if (!confirmed) {
                        return;
                    }

                    this.isLoading = true;
                    try {
                        const response = await fetch(`/api/skills/${name}`, {
                            method: 'DELETE',
                        });

                        if (response.ok) {
                            await this.loadSkills();
                            this.showToast('Skill deleted successfully', 'success');
                        } else {
                            const error = await response.json();
                            this.showToast('Failed to delete: ' + (error.error || 'Unknown error'), 'error');
                        }
                    } catch (error) {
                        console.error('Delete failed:', error);
                        this.showToast('Failed to delete skill', 'error');
                    } finally {
                        this.isLoading = false;
                    }
                }
            }
        }
    </script>
</body>
</html>
